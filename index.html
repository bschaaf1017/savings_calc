<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<div id="employee-calculator" class="savings-calculator">
  <div id="inputs" class="input-wrapper">
    <div class="calculator-input-group">
      <label>Paycheck Frequency:</label><br><br>
      <div class="btn-group">
        <!-- the value for each of these buttons represents how many paychecks someone would recieve in one year at that pay frequency -->
        <button id="freq-btn1" class="freq-btn btn-clicked" value=52>Weekly</button>
        <button id="freq-btn2" class="freq-btn" value=26>Bi-Weekly</button>
        <button id="freq-btn3" class="freq-btn" value=24>Semi-Monthly</button>
        <button id="freq-btn4" class="freq-btn" value=12>Monthly</button>
      </div>
    </div>
    <p class="calculator-input-group">
      <label>Amount saved per paycheck:</label><br><br>
      <input id="paycheck-savings" class="calculator-slider inputs" data-is-currency="true" type="range" min="1"
        max="250" value="5">
      <span id="paycheck-savings-value">$5.00</span>
    </p>
  </div>
  <div class="chart-container">
    <canvas id="myChart"></canvas>
  </div>
  <div class="res-container">
    <p class="sdf-power">
      The power of SDF makes you
      <strong><span id="res-percent"></span></strong>
      times more resilient than 47% of americans
    </p>
    <p class="disclaimer">
      Figures are calculated assuming your employer chooses 5% base
      reward and an annual max reward of $500. Actual rates and rewards
      may vary.
    </p>
  </div>
</div>
<script>
  let freq = 52;

  const colors = {
    orange: {
      fill: '#fcb74e',
      stroke: '#ff9b03',
    },
    grey: {
      fill: '#bdbdbd',
      stroke: '#919191',
    },
  };

  const ctx = document.getElementById('myChart').getContext('2d');
  const myChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [
        `Year 1, 5.26% APY`,
        `Year 2, 2.59% APY`,
        `Year 3, 1.72% APY`,
        `Year 4, 1.29% APY`,
        `Year 5, 1.03% APY`
      ],
      datasets: [
        {
          label: 'Without Sunny Day Fund',
          fill: true,
          backgroundColor: colors.grey.fill,
          pointBackgroundColor: colors.grey.stroke,
          borderColor: colors.grey.stroke,
          pointHighlightStroke: colors.grey.stroke,
          borderCapStyle: 'butt',
          data: [240, 480, 720, 960, 1200],
        },
        {
          label: 'With Sunny Day Fund',
          fill: true,
          backgroundColor: colors.orange.fill,
          pointBackgroundColor: colors.orange.stroke,
          borderColor: colors.orange.stroke,
          pointHighlightStroke: colors.orange.stroke,
          borderCapStyle: 'butt',
          data: [291.72, 583.44, 875.16, 1166.88, 1458.60],
        },
      ]
    },
    options: {
      responsive: true,
      aspectRatio: 1,
      animation: {
        duration: 750,
      },
    }
  });

  // get DOM element
  const get = id => document.getElementById(id).value;
  // set new text value for Dom element
  const set = (id, value) => document.getElementById(id).innerText = value;
  // format $
  const format = number => new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD'
  }).format(number);
  // format %
  const formatPercent = num => new Intl.NumberFormat('default', {
    style: 'percent',
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
  }).format(num);
  // create array of emloyees contributions for 5 years
  const yearlyEmpCont = (checkSavings, payFreq) => {
    const yearlySavings = [];
    for (let i = 1; i <= 5; i++) {
      yearlySavings.push(payFreq * checkSavings * i);
    }
    return yearlySavings;
  }
  // create array of yearly savings including employers rewards over 5 years
  const rewards = (empsConts) => {
    return withRewards = empsConts.map(cont => {
      if ((cont * (1.05 ** 4)) - cont > 500) {
        return (cont + 500).toFixed(2);
      } else {
        return (cont * (1.05 ** 4)).toFixed(2);
      }
    })
  }
  // calculate compounded interest rate for each year
  const CAGR = (startVals, endVals) => {
    return startVals.map((val, idx) => {
      // val = Number.parseFloat(val)
      const numPeriods = (idx + 1) * 4
      const compounded = Math.pow((endVals[idx] / val), 1.05 / numPeriods) - 1;
      return `Year ${idx + 1}, ${Math.round(compounded * 10000) / 100}% APY`;
    })
  }
  // calculate average savings over 5 years to get resilliance %
  const resiliant = (endVals) => {
    const total = endVals.reduce((acc, current)=> acc + Number.parseFloat(current), 0);
    console.log('total: ', total)
    const average = total / 5;
    return (average / 250).toFixed(2);
  }

  const calculate = (event) => {

    const is_pointer_event = event instanceof PointerEvent || event instanceof MouseEvent

    if (is_pointer_event) {
      freq = event.target.value

      const currClicked = new Promise((resolve, reject) => {
        const ele = document.getElementsByClassName('btn-clicked')
        resolve(ele)
      });

      currClicked
        .then((res) => res[0].setAttribute("class", "freq-btn"))
        .then(() => {
          document.getElementById(event.target.id).setAttribute("class", "btn-clicked")
        })
        .catch((err) => console.log('error:', err));
    }


    if (event.target.children.length === 0 && !is_pointer_event) {
      const display_elem_id = `${event.target.id}-value`;
      const is_currency_field = Boolean(event.target.dataset.isCurrency);
      const formatted_value = is_currency_field ? format(event.target.value) : event.target.value;
      set(display_elem_id, formatted_value);
    }

    const savings = get('paycheck-savings');

    const savings_without_sdf = yearlyEmpCont(savings, freq)
    console.log('no rewards=== ', savings_without_sdf)
    // const employer_contribution = (savings_without_sdf * (1.05 ** (q / 3))) - savings_without_sdf;
    const with_employer_rewards = rewards(savings_without_sdf);
    console.log('with rewards = ', with_employer_rewards)
    const sdf_intrest = CAGR(savings_without_sdf, with_employer_rewards)
    console.log('sdf_interest : ', sdf_intrest)
    const resilliant_num = resiliant(with_employer_rewards);
    console.log('resilliant_num: ', resilliant_num)


    myChart.data.labels = sdf_intrest;
    myChart.data.datasets[0].data = savings_without_sdf;
    myChart.data.datasets[1].data = with_employer_rewards;
    myChart.update();

    set('res-percent', resilliant_num)
  };


  document.querySelectorAll('.inputs').forEach((slider) => {
    slider.addEventListener('input', calculate);
  });

  document.querySelectorAll('.freq-btn').forEach((btn) => {
    btn.addEventListener('click', calculate);
  })

  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('paycheck-savings').dispatchEvent(new Event('input', {
      bubbles: true,
      cancelable: true
    }));
  });




</script>

<style>
  .savings-calculator * {
    font-family: Montserrat, sans-serif;
  }

  .savings-calculator {
    max-width: 1000px;
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: space-around;
    padding: 25px 0;
    border: 2px solid #ffa926;
  }

  .input-wrapper {
    display: flex;
    flex-direction: column;
    justify-content: space-around;
  }

  .btn-group {
    display: flex;
    flex-direction: row;
    gap: 2px;
  }

  .freq-btn {
    width: fit-content;
    padding: 3px;
    background-color: white;
    border: 1px solid #004462;
    border-radius: 5px;
    color: #004462;
    cursor: pointer;
  }

  .btn-group button:hover {
    color: #004462;
    background-color: #ffa926;
    border: 1px solid #ffa926;
  }

  .btn-clicked {
    color: #004462;
    border: 1px solid #ffa926;
    border-radius: 5px;
    background-color: #ffa926;
    cursor: pointer;
    width: fit-content;
    padding: 3px
  }

  .calculator-input-group {
    white-space: nowrap;
  }

  .calculator-input-group>* {
    vertical-align: middle;
  }

  .calculator-slider {
    -webkit-appearance: none;
    background: transparent;
    border: none !important;
    width: 100%;
  }

  .calculator-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    margin-top: -4px;
    border: 1px solid #000;
    height: 12px;
    width: 12px;
    border-radius: 6px;
    background: #004462;
  }

  .calculator-slider::-webkit-slider-runnable-track {
    background: #ffa926;
    height: 3px;
  }

  .calculator-slider::-moz-range-thumb {
    background: #004462;
  }

  .calculator-slider::-moz-range-track {
    height: 3px;
    background-color: #ffa926;
  }

  .calculator-slider:focus {
    outline: none;
  }

  .calculator-slider::-ms-track {
    width: 100%;
    cursor: pointer;
    background: transparent;
    border-color: transparent;
    color: transparent;
  }

  .calculator-savings-label {
    color: #ffa926;
    font-weight: bolder;
  }

  .chart-container {
    position: relative;
    height: auto;
    width:50%
  }

  @media only screen and (max-width: 800px) {
    .savings-calculator {
      display: block;
      padding: 8%;
      width: 50%;
      margin-left: auto;
      margin-right: auto;
      min-width: 310px;
    }

    .input-wrapper {
      width: 100%;
    }

    .btn-group {
      width: 100%;
      display: flex;
      flex-direction: row;
      justify-content: space-evenly;
    }

    .calculator-input-group {
      white-space: normal;
      width: 100%;
      display: flex;
      flex-direction: column;
      /* justify-content:center; */
      align-items: center;

    }

    .calculator-input-group>span {
      margin-top: 7px;
    }

    .calculator-slider {
      width: 100%;
    }

    .savings-calculator>div p {
      margin-bottom: 14px;
    }

    .chart-container {
      position: relative;
      height: auto;
      width:100%
    }
  }

  @media only screen and (max-width: 730px) {
    .input-wrapper {
      display: flex;
      justify-content: center;
    }

    .top-inputs {
      display: flex;
      flex-direction: column;
    }
  }


  .res-container {
    /* display: flex;
    flex-direction: column; */
    flex-basis: 100%;
    /* height: 0; */

  }
  .sdf-power {
    text-align: center;
    color: #ffa926;
  }
  .disclaimer {
    text-align: center;
    color: #000;
    font-size: 12px;
  }
  #res-percent {
    color: #004462;
  }
</style>